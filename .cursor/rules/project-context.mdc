---
description: Master index for CoinJar project context
alwaysApply: true
---

# CoinJar - Master Project Context

**Last updated: November 12, 2025**

## Project Overview

CoinJar is a financial portfolio management application for French savings accounts (Livret A, PEA, PEE) with real-time data visualization and multi-language support.

## Tech Stack

- **Frontend**: Next.js 16 (App Router), React, TypeScript (strict mode)
- **Styling**: Tailwind CSS, Shadcn UI (Radix UI primitives)
- **State**: React Server Components, TanStack Query, React Hook Form
- **Backend**: Next.js API Routes, Drizzle ORM, Neon PostgreSQL
- **Auth**: Better Auth (OAuth + Email/Password with bcrypt)
- **i18n**: next-intl (English & French)
- **Charts**: Recharts
- **Testing**: Vitest, Playwright, React Testing Library
- **CI/CD**: GitHub Actions, Husky, lint-staged

## Architecture Overview

Server-first architecture using React Server Components for optimal performance. Features use a layered pattern: authentication → service layer → business logic → UI. Centralized utilities for auth, caching, validation, and calculations eliminate code duplication. Next.js 16 Cache Components with `"use cache"` directive provides granular caching control with `cacheTag()` and `cacheLife()` APIs, and `updateTag()` for immediate cache invalidation in server actions.

## Critical Conventions

### Naming
- **Files**: kebab-case (`user-profile.tsx`)
- **Directories**: kebab-case (`features/livret-a/`)
- **Components**: PascalCase (`UserProfile`)
- **Functions/Variables**: camelCase (`getUserData`)
- **Constants**: UPPERCASE (`CACHE_TAGS`)

### Folder Structure
```
src/
├── app/[locale]/              # App Router pages (locale-aware)
├── features/                  # Business features (livret-a, pea, pee, dashboard)
├── lib/
│   ├── auth/                  # Authentication utilities
│   ├── cache/                 # Cache management
│   ├── services/              # Data access layer
│   ├── calculations/          # Business logic
│   ├── i18n/                  # Translation utilities
│   ├── validation/            # Shared Zod schemas
│   └── utils/                 # UI utilities
├── components/                # Shared UI components
└── db/                        # Database schema & client
```

### Key Patterns
- **Auth**: Always use `requireAuth()` in server actions, `requireAuthForPage()` in pages, `redirectIfAuthenticated()` in login/signup pages
- **Caching**: Use `invalidateFeatureCache(userId, feature)` for mutations
- **Validation**: Use shared schemas from `lib/validation/common-schemas.ts`
- **Translations**: Use `translateTransactionType()`, `translateContributionType()` utilities
- **Server Actions**: Always include `'use server'` directive at top
- **Cache Invalidation**: Invalidate both feature cache AND dashboard cache

## Context Files

### Technical Contexts

**[app-routing-context.mdc](./docs/app-routing-context.mdc)**
App Router patterns, locale-based routing (`/[locale]/...`), layouts, middleware, protected routes

**[api-context.mdc](./docs/api-context.mdc)**
API routes, server actions, Yahoo Finance integration, ISIN validation, cron jobs

**[database-context.mdc](./docs/database-context.mdc)**
Drizzle schema, tables (users, livret_a, pea_*, pee_*), relationships, field meanings

**[auth-context.mdc](./docs/auth-context.mdc)**
Better Auth setup, authentication helpers (`requireAuth`, `getCurrentUserId`, `redirectIfAuthenticated`), bcrypt password hashing, auth page protection

**[frontend-context.mdc](./docs/frontend-context.mdc)**
Client components, TanStack Query patterns, form handling, React Hook Form, number input coercion

**[server-context.mdc](./docs/server-context.mdc)**
Server components, caching strategy, `"use cache"` directive usage, data fetching patterns, service layer

**[styling-context.mdc](./docs/styling-context.mdc)**
Tailwind config, design tokens, Shadcn UI, responsive patterns, styling utilities

**[deployment-context.mdc](./docs/deployment-context.mdc)**
Vercel deployment, environment variables, build config, cron jobs, CI/CD pipeline

### Business Feature Contexts

**[features/livret-a-context.mdc](./docs/features/livret-a-context.mdc)**
Livret A business rules, transaction types (deposit/withdrawal/interest), balance calculation, rate updates

**[features/pea-context.mdc](./docs/features/pea-context.mdc)**
PEA portfolio rules, ISIN validation (12-char format), holdings management, price updates, performance calculation

**[features/pee-context.mdc](./docs/features/pee-context.mdc)**
PEE contribution types (personal, abondement, participation, interessement), share calculations, value tracking

**[features/dashboard-context.mdc](./docs/features/dashboard-context.mdc)**
Dashboard data aggregation, chart calculations (date range, wealth evolution), total return calculation

## Recent Architectural Decisions

### 1. Complete Architecture Refactoring (November 2025)
**Why**: Eliminated ~300 lines of duplicate code following DRY/KISS/SOLID principles

**Impact**: 
- Created centralized auth helpers (`src/lib/auth/`)
- Created cache management utilities (`src/lib/cache/helpers.ts`)
- Created service layer with `getOrCreate` pattern
- Created shared validation schemas
- 50% reduction in cache boilerplate, 40% reduction in auth checks

**See**: `REFACTORING_SUMMARY.md`

### 2. Tag-Based Caching with Next.js 16 (October 2025)
**Why**: Pages were refetching data on every visit despite expensive database queries

**Impact**:
- All queries use `unstable_cache` with user-scoped tags
- Mutations use `revalidateTag` + `revalidatePath` + `router.refresh()`
- Cascading invalidation (feature cache + dashboard cache)
- Dramatic performance improvement

**See**: `src/lib/cache/tags.ts`, `src/lib/cache/helpers.ts`

### 3. Mobile-First Responsive Redesign (September 2025)
**Why**: Tables were unusable on mobile devices

**Impact**:
- Created responsive card layouts for all tables
- `TransactionList`, `PeaHoldingsTable`, `ContributionTable` components
- Breakpoint-aware rendering (md/lg)
- Standardized button sizing and spacing

**See**: Feature components in `src/features/*/components/`

## Key Files to Know

### Most Important
- `src/lib/auth/helpers.ts` - Authentication utilities used everywhere
- `src/lib/cache/helpers.ts` - Cache invalidation utilities
- `src/lib/cache/tags.ts` - Cache tag definitions
- `src/lib/services/account-service.ts` - `getOrCreate` pattern for accounts
- `src/features/dashboard/services.ts` - Consolidated dashboard data fetching
- `src/lib/validation/common-schemas.ts` - Shared Zod schemas

### Configuration
- `src/i18n/request.ts` - next-intl configuration
- `src/db/client.ts` - Drizzle database client
- `src/lib/auth/auth.ts` - Better Auth configuration
- `tailwind.config.ts` - Design system tokens

### Critical Patterns
- `src/features/*/actions.ts` - Server action patterns
- `src/features/*/schema.ts` - Validation schema patterns
- `src/features/*/components/*` - Component composition patterns

## Getting Started

1. Read this master index first
2. Read relevant technical contexts for your work area
3. Read relevant business feature contexts to understand domain logic
4. Refer back to specific contexts as needed

## Development Commands

```bash
pnpm dev          # Start dev server
pnpm build        # Production build
pnpm db:push      # Push schema changes
pnpm db:seed      # Seed database (mock@example.com / Password123!)
pnpm test         # Run unit tests
pnpm test:e2e     # Run Playwright tests
pnpm lint         # Run ESLint
pnpm precommit    # Run pre-commit checks manually
```

## When to Update Context Files

- **Immediately**: When adding new features, changing architecture, or making non-obvious decisions
- **Always**: Update "Last updated" date at top of modified files
- **Never**: Document basic Next.js/React patterns (agents already know these)
- **Split files**: If a context file exceeds 500 lines, split it further
