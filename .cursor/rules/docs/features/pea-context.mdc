---
description: PEA portfolio management, ISIN validation, and performance tracking
---

# PEA Context

**Last updated: November 11, 2025**

## Business Overview

**What is PEA**: Plan d'Épargne en Actions (French equity savings plan)

**Key Characteristics**:
- Tax-advantaged investment account for EU stocks/ETFs
- Tax benefits after 5 years
- Investments in European securities
- Portfolio tracking with real-time performance
- Identified by ISIN codes (International Securities Identification Number)

## Account Structure

**Database Tables**: `pea_accounts` and `pea_holdings`

**Account Fields**:
- `name`: Account name (default "Mon PEA")
- `totalInvestment`: Cumulative money invested (never decreases)

**Holding Fields**:
- `isin`: 12-character security identifier
- `name`: Security name (e.g., "Lyxor CAC 40 UCITS ETF")
- `shares`: Number of shares owned (supports fractional shares)
- `purchasePrice`: Price per share at purchase
- `purchaseDate`: Date of purchase
- `lastUpdatedPrice`: Current price per share (nullable until first fetch)
- `lastPriceUpdate`: Timestamp of last price fetch (nullable)

**Account Creation**: Lazy (created on first page visit using `getOrCreatePea()`)

## ISIN Validation

### ISIN Format

**Standard**: ISO 6166

**Structure**: 12 characters
- Characters 1-2: Country code (e.g., FR for France)
- Characters 3-11: Alphanumeric identifier
- Character 12: Check digit

**Regex Pattern**: `/^[A-Z]{2}[A-Z0-9]{9}[0-9]$/`

**Examples**:
- `FR0010315770` - Lyxor CAC 40 UCITS ETF
- `IE00B4L5Y983` - iShares Core MSCI World ETF
- `LU0392494562` - Amundi MSCI World ETF

### Validation Process

**Flow**:
1. User enters ISIN in form
2. Client debounces input (500ms)
3. TanStack Query calls `/api/validate-isin?isin={code}`
4. Server validates format first (regex)
5. Server calls Yahoo Finance API
6. API returns security name and symbol
7. Form auto-fills security name
8. User can proceed with adding holding

**API Endpoint**: `GET /api/validate-isin?isin={code}`

**Response Success**:
```typescript
{
  name: "Lyxor CAC 40 (DR) UCITS ETF",
  symbol: "CAC.PA"
}
```

**Response Error**: 404 status if invalid or not found

**Debouncing**: 500ms to reduce API calls

**Caching**: TanStack Query caches results for 5 minutes

### Security Measures

1. **Format Validation**: Regex check before API call
2. **Length Check**: Exactly 12 characters required
3. **URL Encoding**: Uses `URLSearchParams` to prevent injection
4. **Error Handling**: Clear error messages for invalid ISINs

## Holdings Management

### Adding Holdings

**User Workflow**:
1. User clicks "Add Holding"
2. Dialog opens with form
3. User enters ISIN (debounced validation)
4. Name auto-fills from API
5. User enters shares and purchase price
6. User selects purchase date
7. Submits form
8. Server action:
   - Validates ISIN format
   - Creates holding record
   - Updates `totalInvestment` (shares * purchasePrice)
   - Invalidates PEA and dashboard caches
9. Dialog closes, success toast
10. Holding appears in table

**Validation**:
- ISIN: 12 characters, valid format, exists in Yahoo Finance
- Shares: Positive number, supports up to 4 decimal places
- Purchase price: Positive number, in euros
- Purchase date: Valid date, not in future

### Editing Holdings

**User Workflow**:
1. User clicks "Edit" on holding row
2. Dialog opens with pre-filled form
3. User can modify:
   - Shares
   - Purchase price
   - Purchase date
4. **Cannot modify**: ISIN (would be different security)
5. Submits form
6. Server action:
   - Updates holding record
   - Recalculates `totalInvestment`
   - Invalidates PEA and dashboard caches
7. Dialog closes, success toast
8. Updated holding in table

### Deleting Holdings

**User Workflow**:
1. User clicks "Delete" on holding row
2. Confirmation dialog appears
3. User confirms
4. Server action:
   - Deletes holding record
   - Updates `totalInvestment` (subtracts purchase value)
   - Invalidates PEA and dashboard caches
5. Success toast
6. Holding removed from table

**Important**: Deleting holding adjusts `totalInvestment` to maintain accurate gain calculation

### Refreshing Prices

**Manual Refresh**:
1. User clicks "Refresh Prices" button
2. Server action:
   - Fetches all ISINs from account holdings
   - Calls `fetchMultipleEtfPrices()` (parallel fetching)
   - Updates `lastUpdatedPrice` and `lastPriceUpdate` for each holding
   - Skips holdings where API fails (preserves old price)
   - Invalidates PEA and dashboard caches
3. Success toast with count of updated prices
4. Table refreshes with new prices

**Automatic Refresh**:
- Cron job runs daily at 2 AM
- Same process as manual refresh
- Updates all PEA holdings across all users

**API Endpoint**: `/api/cron/update-etf-prices`

## Performance Calculations

### Location

`src/features/pea/calculations.ts`

### Portfolio Metrics

**calculatePortfolioMetrics**:
```typescript
export function calculatePortfolioMetrics(holdings) {
  const totalInvestment = sum(shares * purchasePrice)
  const currentValue = sum(shares * lastUpdatedPrice)
  const gain = currentValue - totalInvestment
  const performance = (gain / totalInvestment) * 100
  
  return { totalInvestment, currentValue, gain, performance }
}
```

**Displayed On**: Portfolio metrics cards

### Per-Holding Performance

**calculateHoldingPerformance**:
```typescript
export function calculateHoldingPerformance(holding) {
  const purchaseValue = holding.shares * holding.purchasePrice
  const currentValue = holding.shares * (holding.lastUpdatedPrice ?? holding.purchasePrice)
  const gain = currentValue - purchaseValue
  const performance = (gain / purchaseValue) * 100
  
  return { purchaseValue, currentValue, gain, performance }
}
```

**Displayed On**: Each row in holdings table

### Key Metrics

**Total Investment**: 
- Cumulative money put into PEA
- Never decreases (even when selling in real life, tracks total invested)
- Updated when adding/editing holdings

**Current Value**:
- Sum of (shares * current price) for all holdings
- Uses last updated price if available, else purchase price
- Represents current portfolio worth

**Gain/Loss**:
- Current value - Total investment
- Can be positive (gain) or negative (loss)
- Absolute amount in euros

**Performance**:
- (Gain / Total investment) * 100
- Percentage return on investment
- Displayed with % symbol

## Business Rules

### Total Investment Tracking

**Purpose**: Calculate accurate gain/loss

**Behavior**:
- Increases when adding holdings
- Adjusts when editing holdings
- Decreases when deleting holdings
- Never decreases from price changes (only tracks money invested)

**Example**:
1. Buy 10 shares at 100€ → totalInvestment: 1,000€
2. Price drops to 80€ → totalInvestment: still 1,000€ (not 800€)
3. Buy 5 more at 80€ → totalInvestment: 1,400€

### Price Update Fallback

**Behavior**: If price fetch fails, preserve old price

**Why**: Better to show outdated price than no price

**Indicator**: `lastPriceUpdate` timestamp shows data freshness

### Fractional Shares

**Support**: Up to 4 decimal places

**Why**: Some brokers allow fractional share purchases

**Example**: 10.2547 shares is valid

## UI Components

### Page Location

`src/app/[locale]/dashboard/pea/page.tsx`

### Main Components

**PeaContent** (`src/features/pea/components/pea-content.tsx`):
- Main container for PEA page
- Shows portfolio metrics
- Shows holdings table
- Contains action buttons

**PeaMetricsCards** (`src/features/pea/components/pea-metrics-cards.tsx`):
- Displays 4 metric cards:
  1. Total Investment
  2. Current Value
  3. Gain/Loss
  4. Performance (%)

**PeaHoldingsTable** (`src/features/pea/components/pea-holdings-table.tsx`):
- Displays holdings with performance
- Desktop: Table view
- Mobile: Card view (< lg breakpoint)
- Shows per-holding gain/loss and performance
- Edit and delete actions per row

**AddHoldingDialog**:
- Form for adding new holdings
- ISIN input with real-time validation
- Auto-fill name from API
- Shares, purchase price, purchase date inputs

**EditHoldingDialog**:
- Similar to add dialog
- Pre-filled with current values
- Cannot change ISIN

### Skeleton Loading

**PeaSkeleton**: Displayed while page loads

**Structure**:
- 4 metric card skeletons
- Holdings table skeleton

**Usage**: Wrapped in Suspense boundary

## External API Integration

### Yahoo Finance API

**Base URL**: `https://query1.finance.yahoo.com/v1/finance/`

**Endpoints Used**:
1. `/search` - ISIN validation and name lookup
2. `/quote` - Price fetching

**Helper Location**: `src/lib/yahoo-finance.ts`

**Functions**:
```typescript
async function validateIsin(isin: string): Promise<{ name: string; symbol: string }>
async function fetchEtfPrice(isin: string): Promise<number | null>
async function fetchMultipleEtfPrices(isins: string[]): Promise<Map<string, number>>
```

**Rate Limiting**: None on server (debounced on client)

**Error Handling**: Returns null for failed fetches, throws for invalid ISINs

## Cache Management

### Cache Tags

**Tag**: `pea-${userId}`

**Includes**:
- PEA account data
- Holdings with prices

### Invalidation

**When**:
- After adding holding
- After editing holding
- After deleting holding
- After refreshing prices

**How**:
```typescript
await invalidateFeatureCache(userId, 'pea')
// Also invalidates dashboard cache
```

**Client-Side**:
```typescript
router.refresh() // Refresh server components
```

## Testing

### Unit Tests

**Location**: `tests/unit/pea-calculations.test.ts`

**Tests**:
- Portfolio metrics calculation
- Per-holding performance calculation
- Gain/loss calculation

### E2E Tests

**Location**: `tests/e2e/pea.spec.ts`

**Tests**:
- Add holding with ISIN validation
- Edit holding
- Delete holding
- Refresh prices
- Performance display

## Common Scenarios

### First-Time User

1. User navigates to PEA page
2. Account doesn't exist yet
3. `getOrCreatePea()` creates account with default values
4. Page displays empty state (no holdings)
5. User prompted to add first holding

### Adding First Holding

1. User clicks "Add Holding"
2. Enters ISIN (e.g., FR0010315770)
3. Waits 500ms (debounce)
4. Name auto-fills: "Lyxor CAC 40 UCITS ETF"
5. Enters shares: 10
6. Enters purchase price: 50€
7. Selects date
8. Submits
9. Holding appears in table
10. Total investment: 500€

### Price Update

1. User clicks "Refresh Prices"
2. API fetches current prices (parallel)
3. Holding prices updated
4. Current value recalculated
5. Gain/loss updated
6. Performance % updated
7. Success toast shows count

### Portfolio Growth

1. Day 1: Buy 10 shares at 50€ → Investment: 500€, Value: 500€
2. Day 30: Price rises to 55€ → Investment: 500€, Value: 550€, Gain: +50€ (+10%)
3. Day 60: Buy 5 more at 55€ → Investment: 775€, Value: 825€, Gain: +50€ (+6.45%)

## Future Enhancements

1. **Sell Transactions**: Track selling holdings (reduce shares, lock-in gains)
2. **Dividends**: Track dividend payments
3. **Historical Charts**: Show portfolio value over time
4. **Sector Allocation**: Categorize holdings by sector
5. **Auto-Sync**: Connect to broker API for automatic updates
6. **Currency Conversion**: Support holdings in different currencies
7. **Tax Calculator**: Estimate tax implications
8. **Alerts**: Price alerts for holdings

## Troubleshooting

### ISIN Validation Failing

**Problem**: Valid ISIN not recognized

**Solutions**:
1. Check ISIN format (exactly 12 characters)
2. Verify security exists on Paris exchange (.PA)
3. Try different exchange suffix
4. Check Yahoo Finance API availability
5. Manually enter name if API fails

### Prices Not Updating

**Problem**: Refresh button doesn't update prices

**Solutions**:
1. Check Yahoo Finance API availability
2. Verify ISINs are valid
3. Check for API rate limiting
4. Try refreshing individual holdings
5. Check cron job logs for failures

### Incorrect Performance

**Problem**: Performance percentage seems wrong

**Solutions**:
1. Verify total investment is accurate
2. Check current prices are up-to-date
3. Recalculate manually: (current - investment) / investment
4. Check for edited holdings (price changes affect calculation)
5. Verify shares count is correct
